// You will need to install these packages:
// npm install react react-dom react-quill dompurify slugify

// NOTE: This version is adapted to run as a single, self-contained React application
// in a browser-based environment, simulating Next.js routing and API interactions.
// For *actual* MongoDB integration, you would need a separate Node.js backend
// (e.g., Next.js API routes or an Express server) to handle the database logic.
// The `dbConnect` and `Post` model parts in the comments below illustrate
// how the backend would typically interact with MongoDB.

import React, { useState, useEffect, useCallback } from 'react';
import DOMPurify from 'dompurify'; // For sanitizing HTML content
import slugify from 'slugify'; // For generating SEO-friendly slugs

// Dynamically import ReactQuill
const ReactQuill = React.lazy(() => import('react-quill'));


// --- MOCK BACKEND (Simulates API interactions for client-side demo) ---
// In a real application, these would be actual fetch calls to a Node.js server.
// For the purpose of getting the React app runnable and demonstrating functionality,
// we simulate data storage in memory.

// Mock data storage
let mockPosts = [];

// Mock utility for slug uniqueness (simple version)
const generateUniqueSlug = (title) => {
    let baseSlug = slugify(title, { lower: true, strict: true });
    let slug = baseSlug;
    let counter = 1;
    while (mockPosts.some(p => p.slug === slug)) {
        slug = `${baseSlug}-${counter}`;
        counter++;
    }
    return slug;
};

// Mock API functions
const mockApi = {
    getPosts: async () => {
        await new Promise(resolve => setTimeout(resolve, 300)); // Simulate network delay
        return { success: true, data: [...mockPosts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)) };
    },
    createPost: async ({ title, content }) => {
        await new Promise(resolve => setTimeout(resolve, 500)); // Simulate network delay
        const cleanContent = DOMPurify.sanitize(content, { USE_PROFILES: { html: true } });
        const slug = generateUniqueSlug(title);
        const newPost = {
            title,
            content: cleanContent,
            slug,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            id: Date.now() + Math.random().toString(36).substring(7) // Simple unique ID
        };
        mockPosts.push(newPost);
        return { success: true, data: newPost };
    },
    getPostBySlug: async (slug) => {
        await new Promise(resolve => setTimeout(resolve, 300)); // Simulate network delay
        const post = mockPosts.find(p => p.slug === slug);
        if (post) {
            return { success: true, data: { ...post } };
        }
        return { success: false, message: 'Post not found.' };
    },
    updatePost: async (originalSlug, { title, content, slug: newSlug }) => {
        await new Promise(resolve => setTimeout(resolve, 500)); // Simulate network delay
        const index = mockPosts.findIndex(p => p.slug === originalSlug);
        if (index === -1) {
            return { success: false, message: 'Post not found.' };
        }

        const cleanContent = DOMPurify.sanitize(content, { USE_PROFILES: { html: true } });
        let finalSlug = newSlug || originalSlug;

        // Check for slug uniqueness if it changed and is not the original slug
        if (newSlug && newSlug !== originalSlug && mockPosts.some((p, i) => i !== index && p.slug === newSlug)) {
            return { success: false, message: 'Another post with this new slug already exists. Please choose a different slug.' };
        }

        mockPosts[index] = {
            ...mockPosts[index],
            title,
            content: cleanContent,
            slug: finalSlug,
            updatedAt: new Date().toISOString()
        };
        return { success: true, data: { ...mockPosts[index] } };
    },
    deletePost: async (slug) => {
        await new Promise(resolve => setTimeout(resolve, 300)); // Simulate network delay
        const initialLength = mockPosts.length;
        mockPosts = mockPosts.filter(p => p.slug !== slug);
        if (mockPosts.length < initialLength) {
            return { success: true, message: 'Post deleted successfully.' };
        }
        return { success: false, message: 'Post not found.' };
    }
};

// --- REAL BACKEND (Concept - Not runnable in this browser environment) ---
/*
// utils/dbConnect.js
import mongoose from 'mongoose';

const MONGODB_URI = process.env.MONGODB_URI; // This would be read from server-side env

if (!MONGODB_URI) {
  console.error('MONGODB_URI is not defined. Database connection will fail.');
}

let cached = global.mongoose;
if (!cached) {
  cached = global.mongoose = { conn: null, promise: null };
}

export async function dbConnect() {
  if (cached.conn) {
    return cached.conn;
  }
  if (!cached.promise) {
    const opts = {
      bufferCommands: false,
      useNewUrlParser: true, // Deprecated in recent Mongoose, but good for older versions
      useUnifiedTopology: true, // Deprecated in recent Mongoose, but good for older versions
    };
    cached.promise = mongoose.connect(MONGODB_URI, opts).then((mongoose) => {
      return mongoose;
    });
  }
  cached.conn = await cached.promise;
  return cached.conn;
}

// models/Post.js
const PostSchema = new mongoose.Schema(
  {
    title: { type: String, required: true },
    content: { type: String, required: true }, // HTML content
    slug: { type: String, required: true, unique: true }, // SEO-friendly slug
  },
  { timestamps: true } // Adds createdAt and updatedAt automatically
);
export const Post = mongoose.models.Post || mongoose.model('Post', PostSchema);

// Example API handler (pages/api/posts/create.js in Next.js)
export default async function apiCreatePost(req, res) {
  if (req.method === 'POST') {
    await dbConnect();
    const { title, content } = req.body;
    try {
      const cleanContent = DOMPurify.sanitize(content, { USE_PROFILES: { html: true } });
      let baseSlug = slugify(title, { lower: true, strict: true });
      let slug = baseSlug;
      let counter = 1;
      while (await Post.findOne({ slug })) {
        slug = `${baseSlug}-${counter}`;
        counter++;
      }
      const post = await Post.create({ title, content: cleanContent, slug });
      res.status(201).json({ success: true, data: post });
    } catch (error) {
      if (error.code === 11000) {
        return res.status(409).json({ success: false, message: 'A post with this title already exists.' });
      }
      res.status(400).json({ success: false, message: error.message });
    }
  } else {
    res.status(405).json({ success: false, message: 'Method not allowed.' });
  }
}
*/

// --- CUSTOM CLIENT-SIDE ROUTER (Simulates Next.js useRouter and Link) ---
const RouterContext = React.createContext(null);

function useRouterMock() {
  const [pathname, setPathname] = useState(window.location.pathname);
  const [query, setQuery] = useState({});

  useEffect(() => {
    const handlePopState = () => {
      setPathname(window.location.pathname);
      setQuery(parseQueryParams(window.location.search));
    };
    window.addEventListener('popstate', handlePopState);
    return () => window.removeEventListener('popstate', handlePopState);
  }, []);

  useEffect(() => {
    setQuery(parseQueryParams(window.location.search));
  }, [pathname]);

  const push = useCallback((url) => {
    window.history.pushState(null, '', url);
    setPathname(url.split('?')[0]);
    setQuery(parseQueryParams(url.split('?')[1] || ''));
  }, []);

  const replace = useCallback((url) => {
    window.history.replaceState(null, '', url);
    setPathname(url.split('?')[0]);
    setQuery(parseQueryParams(url.split('?')[1] || ''));
  }, []);

  const parseQueryParams = (queryString) => {
    const params = {};
    if (queryString) {
      queryString.replace('?', '').split('&').forEach(pair => {
        const [key, value] = pair.split('=');
        params[key] = decodeURIComponent(value || '');
      });
    }
    return params;
  };

  const isFallback = false; // Simplified, always false for this mock router

  return { pathname, query, push, replace, isFallback };
}

const LinkMock = ({ href, children, className }) => {
  const { push } = React.useContext(RouterContext);
  const handleClick = (e) => {
    e.preventDefault();
    push(href);
  };
  return <a href={href} onClick={handleClick} className={className}>{children}</a>;
};


// --- COMPONENTS ---

// components/Layout.js
const Layout = ({ children, title = "Modern Blog" }) => {
    useEffect(() => {
        document.title = title;
    }, [title]);

    return (
        <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
            {/* Tailwind CSS CDN and Quill CSS embedded directly for this environment */}
            <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet" />
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
            <style>
                {`
                body { font-family: 'Inter', sans-serif; }
                /* Custom styles for Quill editor content to make it look good */
                .ql-editor {
                    min-height: 250px;
                }
                .prose {
                    max-width: 80ch; /* Limit line length for readability */
                }
                .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
                    margin-top: 1.5em;
                    margin-bottom: 0.5em;
                    font-weight: 700;
                    color: #1a202c; /* dark gray */
                }
                .prose p {
                    margin-bottom: 1em;
                }
                .prose a {
                    color: #4c51bf; /* indigo */
                    text-decoration: underline;
                }
                .prose ul, .prose ol {
                    padding-left: 1.5em;
                    margin-bottom: 1em;
                }
                .prose li {
                    margin-bottom: 0.5em;
                }
                .prose blockquote {
                    border-left: 4px solid #a78bfa; /* light indigo */
                    padding-left: 1em;
                    font-style: italic;
                    color: #4a5568; /* gray */
                    margin: 1em 0;
                }
                .prose pre {
                    background-color: #e2e8f0; /* light gray */
                    padding: 1em;
                    border-radius: 0.5rem;
                    overflow-x: auto;
                }
                .prose code {
                    background-color: #edf2f7; /* lighter gray */
                    padding: 0.2em 0.4em;
                    border-radius: 0.25rem;
                    font-size: 0.9em;
                }
                .ql-container.ql-snow {
                    border-bottom-left-radius: 0.5rem;
                    border-bottom-right-radius: 0.5rem;
                }
                .ql-toolbar.ql-snow {
                    border-top-left-radius: 0.5rem;
                    border-top-right-radius: 0.5rem;
                }
                .ql-snow .ql-stroke {
                    stroke: #4c51bf !important; /* Tailwind indigo-700 */
                }
                .ql-snow .ql-fill {
                    fill: #4c51bf !important; /* Tailwind indigo-700 */
                }
                .ql-snow .ql-active .ql-stroke {
                    stroke: #3730a3 !important; /* Tailwind indigo-800 */
                }
                .ql-snow .ql-active .ql-fill {
                    fill: #3730a3 !important; /* Tailwind indigo-800 */
                }
                .ql-snow .ql-picker.ql-expanded .ql-picker-label {
                    border-color: #4c51bf !important;
                }
                .ql-snow .ql-picker.ql-expanded .ql-picker-options {
                    border-color: #4c51bf !important;
                }
                `}
            </style>
            <link href="https://cdn.jsdelivr.net/npm/react-quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />

            <header className="bg-white shadow-sm p-4 sticky top-0 z-10">
                <nav className="container mx-auto flex justify-between items-center">
                    <LinkMock href="/" className="text-2xl font-bold text-indigo-700 hover:text-indigo-900 rounded-lg px-2 py-1 transition duration-300">
                        My Modern Blog
                    </LinkMock>
                    <div className="space-x-4">
                        <LinkMock href="/admin" className="text-gray-600 hover:text-gray-900 font-medium px-3 py-2 rounded-lg transition duration-300 bg-gray-50 hover:bg-gray-100">
                            Admin Dashboard
                        </LinkMock>
                        <LinkMock href="/admin/create" className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">
                            Create New Post
                        </LinkMock>
                    </div>
                </nav>
            </header>

            <main className="container mx-auto p-4 md:p-8">
                {children}
            </main>

            <footer className="bg-gray-800 text-white p-6 text-center mt-12">
                <p>&copy; {new Date().getFullYear()} Modern Blog. All rights reserved.</p>
                <p className="text-sm mt-2">Built with React, Tailwind CSS, and Mocked MongoDB.</p>
            </footer>
        </div>
    );
};

// components/LoadingSpinner.js
const LoadingSpinner = () => (
  <div className="flex justify-center items-center py-8">
    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
    <p className="ml-4 text-lg text-indigo-600">Loading...</p>
  </div>
);

// components/PostForm.js
const PostForm = ({ initialData = {}, onSubmit, isEditing = false, isLoading = false }) => {
  const [title, setTitle] = useState(initialData.title || '');
  const [content, setContent] = useState(initialData.content || '');
  const [slug, setSlug] = useState(initialData.slug || '');
  const [showSlugWarning, setShowSlugWarning] = useState(false);

  // New states for Gemini API integration
  const [isSummarizing, setIsSummarizing] = useState(false);
  const [summaryOutput, setSummaryOutput] = useState('');
  const [summaryError, setSummaryError] = useState('');

  // Update form fields if initialData changes (e.g., when editing a post)
  useEffect(() => {
    if (initialData.title) setTitle(initialData.title);
    if (initialData.content) setContent(initialData.content);
    if (initialData.slug) setSlug(initialData.slug);
    // Clear summary when initial data changes
    setSummaryOutput('');
    setSummaryError('');
  }, [initialData]);

  // Auto-generate slug from title for new posts, or if title changes during edit
  useEffect(() => {
    if (!isEditing || (isEditing && title !== initialData.title)) {
      const generatedSlug = slugify(title, { lower: true, strict: true });
      setSlug(generatedSlug);
    }
  }, [title, isEditing, initialData.title]);

  const handleSubmit = (e) => {
    e.preventDefault();
    onSubmit({ title, content, slug });
  };

  const quillModules = {
    toolbar: [
      [{ 'header': '1' }, { 'header': '2' }, { 'font': [] }],
      [{ size: [] }],
      ['bold', 'italic', 'underline', 'strike', 'blockquote'],
      [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'indent': '-1' }, { 'indent': '+1' }],
      ['link', 'image', 'video'],
      ['clean']
    ],
  };

  const quillFormats = [
    'header', 'font', 'size',
    'bold', 'italic', 'underline', 'strike', 'blockquote',
    'list', 'bullet', 'indent',
    'link', 'image', 'video'
  ];

  // Function to call Gemini API for content summarization
  const handleSummarizeContent = async () => {
    setIsSummarizing(true);
    setSummaryOutput('');
    setSummaryError('');

    if (!content) {
      setSummaryError("Please enter some content to summarize.");
      setIsSummarizing(false);
      return;
    }

    try {
      // Use DOMPurify to strip HTML tags for cleaner LLM input
      const plainTextContent = DOMPurify.sanitize(content, { USE_PROFILES: { html: false } });

      let chatHistory = [];
      const prompt = `Summarize the following blog post content concisely:\n\n${plainTextContent}`;
      chatHistory.push({ role: "user", parts: [{ text: prompt }] });
      const payload = { contents: chatHistory };
      const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

      const response = await fetch(apiUrl, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             });

      const result = await response.json(); // Use await here
      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const text = result.candidates[0].content.parts[0].text;
        setSummaryOutput(text);
      } else {
        setSummaryError("Failed to generate summary. No content in response.");
      }
    } catch (error) {
      console.error("Error summarizing content:", error);
      setSummaryError(`Error summarizing content: ${error.message || 'Unknown error'}`);
    } finally {
      setIsSummarizing(false);
    }
  };

  const copyToClipboard = (text) => {
    // This is a basic way to copy to clipboard for browser environments.
    // In some sandboxed environments, navigator.clipboard.writeText might be restricted.
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      alert('Summary copied to clipboard!'); // Using alert for simplicity in this demo, replace with custom modal in production
    } catch (err) {
      console.error('Failed to copy text:', err);
      alert('Failed to copy summary. Please copy manually.');
    }
    document.body.removeChild(textarea);
  };


  return (
    <form onSubmit={handleSubmit} className="bg-white p-6 rounded-lg shadow-lg">
      <div className="mb-4">
        <label htmlFor="title" className="block text-gray-700 text-sm font-bold mb-2">
          Title:
        </label>
        <input
          type="text"
          id="title"
          className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          required
        />
      </div>

      <div className="mb-4">
        <label htmlFor="content" className="block text-gray-700 text-sm font-bold mb-2 flex justify-between items-center">
          Content:
          <button
            type="button"
            onClick={handleSummarizeContent}
            className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-300 shadow-md flex items-center"
            disabled={isSummarizing || isLoading}
          >
            {isSummarizing ? (
              <>
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                Summarizing...
              </>
            ) : (
              '✨ Summarize Content'
            )}
          </button>
        </label>
        <React.Suspense fallback={<LoadingSpinner />}>
          <ReactQuill
            theme="snow"
            value={content}
            onChange={setContent}
            modules={quillModules}
            formats={quillFormats}
            className="bg-white rounded-lg"
            placeholder="Start writing your amazing blog post here..."
          />
        </React.Suspense>

        {summaryError && (
          <p className="text-red-600 text-sm mt-2">{summaryError}</p>
        )}
        {summaryOutput && (
          <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg shadow-inner">
            <h4 className="text-lg font-semibold text-blue-800 mb-2">Generated Summary:</h4>
            <p className="text-blue-700 whitespace-pre-wrap">{summaryOutput}</p>
            <button
              type="button"
              onClick={() => copyToClipboard(summaryOutput)}
              className="mt-3 bg-blue-500 text-white px-3 py-1 text-sm rounded-lg hover:bg-blue-600 transition duration-300"
            >
              Copy Summary
            </button>
          </div>
        )}
      </div>

      <div className="mb-6">
        <label htmlFor="slug" className="block text-gray-700 text-sm font-bold mb-2">
          Slug (SEO-friendly URL part):
        </label>
        <input
          type="text"
          id="slug"
          className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 bg-gray-50 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500"
          value={slug}
          onChange={(e) => {
            setSlug(e.target.value);
            setShowSlugWarning(true);
          }}
          disabled={!isEditing && title === ''} // Disable if creating and no title yet
          title={isEditing ? "Changing slug can affect SEO. Proceed with caution." : "Slug is auto-generated from title."}
        />
        {isEditing && showSlugWarning && (
          <p className="text-orange-600 text-xs mt-1">
            Warning: Changing the slug for an existing post can break old links and affect SEO.
          </p>
        )}
      </div>

      <button
        type="submit"
        className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-300 shadow-md"
        disabled={isLoading}
      >
        {isLoading ? (isEditing ? 'Updating...' : 'Creating...') : (isEditing ? 'Update Post' : 'Create Post')}
      </button>
    </form>
  );
};

// components/ConfirmationModal.js
const ConfirmationModal = ({ show, title, message, onConfirm, onCancel }) => {
  if (!show) return null;

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
        <h3 className="text-xl font-bold text-gray-800 mb-4">{title}</h3>
        <p className="text-gray-700 mb-6">{message}</p>
        <div className="flex justify-end space-x-4">
          <button
            onClick={onCancel}
            className="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition duration-200"
          >
            Cancel
          </button>
          <button
            onClick={onConfirm}
            className="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition duration-200"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>
  );
};

// --- PAGES ---

// HomePage (Public Home Page - lists recent posts)
function HomePage({ posts }) {
  // Simulating server-side props fetching for the home page
  const [currentPosts, setCurrentPosts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchPosts = async () => {
      setLoading(true);
      setError(null);
      try {
        const res = await mockApi.getPosts();
        if (res.success) {
          setCurrentPosts(res.data);
        } else {
          setError(res.message);
        }
      } catch (err) {
        setError("Failed to fetch posts.");
      } finally {
        setLoading(false);
      }
    };
    fetchPosts();
  }, []); // Empty dependency array means this runs once on mount

  if (loading) return <LoadingSpinner />;
  if (error) return <p className="text-red-600 text-center text-lg mt-10">Error: {error}</p>;

  return (
    <div className="py-8">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8 text-center">Latest Blog Posts</h1>
      {currentPosts.length === 0 ? (
        <p className="text-center text-gray-600 text-lg mt-10">No posts yet. Be the first to create one from the <LinkMock href="/admin/create" className="text-indigo-600 hover:underline">Admin dashboard</LinkMock>!</p>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {currentPosts.map((post) => (
            <div key={post.slug} className="bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 overflow-hidden">
              <div className="p-6">
                <h2 className="text-2xl font-bold text-gray-900 mb-2 truncate">
                  <LinkMock href={`/posts/${post.slug}`} className="hover:text-indigo-700 transition duration-200">
                      {post.title}
                  </LinkMock>
                </h2>
                <p className="text-gray-600 text-sm mb-4">
                  Published on {new Date(post.createdAt).toLocaleDateString()}
                </p>
                {/* Display a snippet of content, safely sanitized */}
                <div
                  className="text-gray-700 line-clamp-3 text-ellipsis overflow-hidden"
                  dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(post.content) }}
                />
                <LinkMock href={`/posts/${post.slug}`} className="mt-4 inline-block text-indigo-600 hover:underline font-medium">
                    Read More &rarr;
                </LinkMock>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}


// AdminDashboardPage (Admin Dashboard - List Posts)
function AdminDashboardPage() {
  const { replace } = useRouterMock(); // Use mock router
  const [currentPosts, setCurrentPosts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [postToDelete, setPostToDelete] = useState(null);
  const [deleting, setDeleting] = useState(false); // For delete operation specifically
  const [feedbackMessage, setFeedbackMessage] = useState('');
  const [feedbackType, setFeedbackType] = useState(''); // 'success' or 'error'

  const fetchPosts = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const res = await mockApi.getPosts();
      if (res.success) {
        setCurrentPosts(res.data);
      } else {
        setError(res.message);
      }
    } catch (err) {
      setError("Failed to fetch posts.");
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchPosts();
  }, [fetchPosts]);

  const handleDeleteClick = (post) => {
    setPostToDelete(post);
    setShowModal(true);
  };

  const handleConfirmDelete = async () => {
    if (!postToDelete) return;

    setDeleting(true);
    setFeedbackMessage('');
    setFeedbackType('');

    try {
      const res = await mockApi.deletePost(postToDelete.slug);
      if (res.success) {
        setFeedbackMessage('Post deleted successfully!');
        setFeedbackType('success');
        fetchPosts(); // Re-fetch posts to update the list
      } else {
        setFeedbackMessage(`Error deleting post: ${res.message || 'Unknown error'}`);
        setFeedbackType('error');
      }
    } catch (err) {
      setFeedbackMessage(`Network error: ${err.message}`);
      setFeedbackType('error');
    } finally {
      setDeleting(false);
      setShowModal(false);
      setPostToDelete(null);
      setTimeout(() => setFeedbackMessage(''), 5000); // Clear message after 5 seconds
    }
  };

  const handleCancelDelete = () => {
    setShowModal(false);
    setPostToDelete(null);
  };

  if (loading) return <LoadingSpinner />;
  if (error) {
    return (
      <div className="py-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-6 text-center">Admin Dashboard</h1>
        <p className="text-red-600 text-center text-lg">Error loading posts: {error}</p>
      </div>
    );
  }

  return (
    <div className="py-8">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8 text-center">Admin Dashboard</h1>

      {feedbackMessage && (
        <div className={`p-4 rounded-lg mb-6 text-center ${feedbackType === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
          {feedbackMessage}
        </div>
      )}

      {deleting && <LoadingSpinner />}

      {currentPosts.length === 0 ? (
        <p className="text-center text-gray-600 text-lg mt-10">
          No posts found. <LinkMock href="/admin/create" className="text-indigo-600 hover:underline">Create a new post</LinkMock>!
        </p>
      ) : (
        <div className="bg-white rounded-lg shadow-lg p-6 overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Title
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Slug
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Created At
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {currentPosts.map((post) => (
                <tr key={post.slug} className="hover:bg-gray-50">
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    <LinkMock href={`/posts/${post.slug}`} className="text-indigo-600 hover:text-indigo-900 hover:underline">
                        {post.title}
                    </LinkMock>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {post.slug}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {new Date(post.createdAt).toLocaleDateString()}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <LinkMock href={`/admin/edit/${post.slug}`} className="text-indigo-600 hover:text-indigo-900 mr-4">
                        Edit
                    </LinkMock>
                    <button
                      onClick={() => handleDeleteClick(post)}
                      className="text-red-600 hover:text-red-900"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      <ConfirmationModal
        show={showModal}
        title="Delete Post"
        message={`Are you sure you want to delete the post "${postToDelete?.title}"? This action cannot be undone.`}
        onConfirm={handleConfirmDelete}
        onCancel={handleCancelDelete}
      />
    </div>
  );
}


// CreatePostPage (Create New Post Page)
function CreatePostPage() {
  const { push } = useRouterMock();
  const [isLoading, setIsLoading] = useState(false);
  const [feedbackMessage, setFeedbackMessage] = useState('');
  const [feedbackType, setFeedbackType] = useState(''); // 'success' or 'error'

  const handleSubmit = async (postData) => {
    setIsLoading(true);
    setFeedbackMessage('');
    setFeedbackType('');

    try {
      const res = await mockApi.createPost(postData);
      if (res.success) {
        setFeedbackMessage('Post created successfully!');
        setFeedbackType('success');
        setTimeout(() => push(`/posts/${res.data.slug}`), 1500); // Redirect to new post page
      } else {
        setFeedbackMessage(`Error creating post: ${res.message || 'Unknown error'}`);
        setFeedbackType('error');
      }
    } catch (error) {
      setFeedbackMessage(`Network error: ${error.message}`);
      setFeedbackType('error');
    } finally {
      setIsLoading(false);
      setTimeout(() => setFeedbackMessage(''), 5000); // Clear message after 5 seconds
    }
  };

  return (
    <div className="py-8">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8 text-center">Create New Blog Post</h1>

      {feedbackMessage && (
        <div className={`p-4 rounded-lg mb-6 text-center ${feedbackType === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
          {feedbackMessage}
        </div>
      )}

      <PostForm onSubmit={handleSubmit} isLoading={isLoading} />
    </div>
  );
}


// EditPostPage (Edit Post Page)
function EditPostPage({ initialSlug }) {
  const { push, replace } = useRouterMock();
  const [post, setPost] = useState(null);
  const [loading, setLoading] = useState(true);
  const [er
